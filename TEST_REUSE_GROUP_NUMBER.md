# ЁЯУЛ р╕кр╕гр╕╕р╕Ыр╕Ьр╕ер╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕гр╕░р╕Ър╕Ър╕Щр╕│р╣Ар╕ер╕Вр╕Бр╕ер╕╕р╣Ир╕бр╕Бр╕ер╕▒р╕Ър╕бр╕▓р╣Гр╕Кр╣Й

## тЬЕ р╕Ьр╕ер╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ

### Test 1: р╕Чр╕Фр╕кр╕нр╕Ъ Algorithm р╕Бр╕▓р╕гр╕лр╕▓р╣Ар╕ер╕Вр╕зр╣Ир╕▓р╕З
```
р╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕╡р╣Ир╕бр╕╡: [2, 3, 4]
р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М: р╕лр╕▓р╣Ар╕ер╕В 1 р╣Ар╕Ир╕н тЬЕ
```

### Test 2: р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕Зр╕Бр╕ер╕╕р╣Ир╕бр╕Хр╕▒р╣Йр╕Зр╣Бр╕Хр╣Ир╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ
```
р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ: []
р╕кр╕гр╣Йр╕▓р╕З 2 р╕Бр╕ер╕╕р╣Ир╕б: [1, 2] тЬЕ
```

### Test 3: р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╕ер╕Ър╣Бр╕ер╕░р╕Щр╕│р╣Ар╕ер╕Вр╕Бр╕ер╕▒р╕Ър╕бр╕▓р╣Гр╕Кр╣Й
```
р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ: [1, 2]
р╕ер╕Ър╕Бр╕ер╕╕р╣Ир╕б 1: [2]
р╕кр╕гр╣Йр╕▓р╕Зр╣Гр╕лр╕бр╣И: [1, 2] тЖР р╣Ар╕ер╕В 1 р╕Цр╕╣р╕Бр╕Щр╕│р╕Бр╕ер╕▒р╕Ър╕бр╕▓р╣Гр╕Кр╣Й тЬЕ
```

### Test 4: р╕Чр╕Фр╕кр╕нр╕Ъ Scenario р╕Лр╕▒р╕Ър╕Лр╣Йр╕нр╕Щ
```
р╕кр╕гр╣Йр╕▓р╕З: [1, 2, 3, 4]
р╕ер╕Ъ: [1, 3, 4] тЖТ р╣Ар╕лр╕ер╕╖р╕н [2]
р╕кр╕гр╣Йр╕▓р╕Зр╣Гр╕лр╕бр╣И 3 р╕Бр╕ер╕╕р╣Ир╕б: [1, 2, 3, 4] тЖР р╕Щр╕│р╣Ар╕ер╕В [1, 3, 4] р╕Бр╕ер╕▒р╕Ър╕бр╕▓р╣Гр╕Кр╣Й тЬЕ
```

## ЁЯОп р╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕Зр╕гр╕░р╕Ър╕Ъ

### Algorithm
```php
// р╕лр╕▓р╣Ар╕ер╕Вр╕зр╣Ир╕▓р╕Зр╕Хр╕▒р╣Йр╕Зр╣Бр╕Хр╣И 1 р╕Цр╕╢р╕З max(group_id) + 1
for ($i = 1; $i <= count($existingGroupIds) + 1; $i++) {
    if (!in_array($i, $existingGroupIds)) {
        $nextGroupId = $i;  // р╣Гр╕Кр╣Йр╣Ар╕ер╕Вр╕Чр╕╡р╣Ир╕зр╣Ир╕▓р╕Зр╕Щр╕╡р╣Й
        break;
    }
}
```

### р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щ
```
р╕бр╕╡р╕Бр╕ер╕╕р╣Ир╕б: [2, 5, 7, 8]

р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ:
- р╣Ар╕ер╕В 1: р╣Др╕бр╣Ир╕бр╕╡р╣Гр╕Щр╕гр╕░р╕Ър╕Ъ тЖТ р╣Гр╕Кр╣Йр╣Ар╕ер╕В 1 тЬЕ

р╕лр╕ер╕▒р╕Зр╕кр╕гр╣Йр╕▓р╕З: [1, 2, 5, 7, 8]
```

### Race Condition Protection
```php
// р╕ер╣Зр╕нр╕Др╕Хр╕▓р╕гр╕▓р╕Зр╕Бр╣Ир╕нр╕Щр╕лр╕▓р╣Ар╕ер╕Вр╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕Зр╕Бр╕ер╕╕р╣Ир╕б
$existingGroupIds = Group::lockForUpdate()
    ->pluck('group_id')
    ->sort()
    ->values()
    ->toArray();
```

## ЁЯФТ р╕Др╕зр╕▓р╕бр╕Ыр╕ер╕нр╕Фр╕ар╕▒р╕в

1. **lockForUpdate()**: р╕ер╣Зр╕нр╕Др╕Хр╕▓р╕гр╕▓р╕З groups р╕Вр╕Ур╕░р╕лр╕▓р╣Ар╕ер╕В
   - р╕Др╕Щр╕Чр╕╡р╣И 1 р╕бр╕▓р╕Бр╣Ир╕нр╕Щ тЖТ р╕ер╣Зр╕нр╕Др╣Бр╕ер╕░р╕лр╕▓р╣Ар╕ер╕В
   - р╕Др╕Щр╕Чр╕╡р╣И 2 р╕бр╕▓р╕Юр╕гр╣Йр╕нр╕бр╕Бр╕▒р╕Щ тЖТ р╕гр╕нр╕Ир╕Щр╕Бр╕зр╣Ир╕▓р╕Др╕Щр╕Чр╕╡р╣И 1 р╕кр╕гр╣Йр╕▓р╕Зр╣Ар╕кр╕гр╣Зр╕И
   - р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╣Ар╕ер╕Вр╕Лр╣Йр╕│ тЬЕ

2. **Transaction**: р╣Гр╕Кр╣Й DB::beginTransaction()
   - Rollback р╕Цр╣Йр╕▓р╣Ар╕Бр╕┤р╕Ф error
   - р╕гр╕▒р╕Бр╕йр╕▓ data integrity тЬЕ

3. **Error Handling**: р╕Ир╕▒р╕Ъ QueryException
   - р╕Хр╕гр╕зр╕Ир╕Ир╕▒р╕Ъ duplicate key (code 23000)
   - р╣Бр╕Ир╣Йр╕Зр╣Гр╕лр╣Йр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╕ер╕нр╕Зр╣Гр╕лр╕бр╣И тЬЕ

## ЁЯУК р╕Вр╣Йр╕нр╕кр╕гр╕╕р╕Ы

тЬЕ **PASS р╕Чр╕╕р╕Бр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ**
- р╕Щр╕│р╣Ар╕ер╕Вр╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕╡р╣Ир╕Цр╕╣р╕Бр╕ер╕Ър╕Бр╕ер╕▒р╕Ър╕бр╕▓р╣Гр╕Кр╣Йр╣Др╕Фр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
- р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щ race condition р╣Др╕Фр╣Йр╕кр╕│р╣Ар╕гр╣Зр╕И
- First Come First Served (р╣Гр╕Др╕гр╕бр╕▓р╕Бр╣Ир╕нр╕Щр╣Др╕Фр╣Йр╣Ар╕ер╕Вр╕Щр╕▒р╣Йр╕Щр╕Бр╣Ир╕нр╕Щ)

## ЁЯОЙ р╕гр╕░р╕Ър╕Ър╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ!
